{"id":735,"date":"2015-08-16T17:45:48","date_gmt":"2015-08-16T09:45:48","guid":{"rendered":"http:\/\/ijz.me\/?p=735"},"modified":"2015-08-16T17:45:48","modified_gmt":"2015-08-16T09:45:48","slug":"perl%e7%89%88%e6%9c%ac%e5%b1%8f%e8%94%bdssh%e6%81%b6%e6%84%8f%e6%89%ab%e6%8f%8fip%e7%9a%84%e8%84%9a%e6%9c%ac","status":"publish","type":"post","link":"http:\/\/ijz.me\/?p=735","title":{"rendered":"perl\u7248\u672c\u5c4f\u853dssh\u6076\u610f\u626b\u63cfip\u7684\u811a\u672c"},"content":{"rendered":"<p>\u4e0a\u4e00\u7bc7\u6587\u7ae0\u8bb2\u4e86\u5c4f\u853dssh\u6076\u610f\u626b\u63cfip\u7684\u811a\u672c\uff0c\u4e3b\u8981\u91cc\u5229\u7528shell\u548cperl-oneline\u4ee3\u7801\uff0c\u540e\u6765\u53c8\u5199\u4e86\u4e00\u4e2a\u7eafperl\u7248\u672c\u7684\uff0c\u4e00\u5e76\u53d1\u4e0a\u4e86\u3002<!--more--><code><\/code><\/p>\n<pre class=\"lang:perl decode:true \">#!\/usr\/bin\/env perl\n\nmy $LIMIT=30;\nmy $log=\"\/var\/log\/secure\";\nmy $LOGFILE=\"\/data\/block_ip.log\";\nmy $TIME=`date '+%b %e %H'`;\nchomp $TIME;\nmy $BLOCK_IP;\nmy %hash;\nopen $FD,'&lt;',$log)||die(\"Can not open the file!$!n\");\n\nwhile(){\nchomp;\nif ( \/$TIME\/ and \/Failed password\/ )\n{\nmy @line=split;\nmy $ip=$line[-4];\n$hash{$ip}++;\n}\n}\nclose $FD;\n\nfor(keys %hash)\n{\n\nif ($hash{$_} &gt; $LIMIT)\n{\nmy $IP=$_;\n$ips= `iptables-save`;\n$mo= qr(\/INPUT\/ and \/DROP\/ and \/$IP\/);\nunless ($ips=~$mo)\n{\n`iptables -I INPUT -s $IP -j DROP`;\nmy $NOW=`date '+%Y-%m-%d %H:%M'`;\nchomp $NOW;\n`echo -e \"$NOW : $IP\" &gt;&gt;$LOGFILE`;\n}\n}\n}<\/pre>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>\u4e0a\u4e00\u7bc7\u6587\u7ae0\u8bb2\u4e86\u5c4f\u853dssh\u6076\u610f\u626b\u63cfip\u7684\u811a\u672c\uff0c\u4e3b\u8981\u91cc\u5229\u7528shell\u548cperl-oneline\u4ee3\u7801\uff0c\u540e\u6765\u53c8\u5199\u4e86\u4e00\u4e2a [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[21,6],"tags":[40,51],"class_list":["post-735","post","type-post","status-publish","format-standard","hentry","category-perl","category-6","tag-perl","tag-51"],"_links":{"self":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/735","targetHints":{"allow":["GET"]}}],"collection":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcomments&post=735"}],"version-history":[{"count":0,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/735\/revisions"}],"wp:attachment":[{"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fmedia&parent=735"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcategories&post=735"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Ftags&post=735"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}