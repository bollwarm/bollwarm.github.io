{"id":731,"date":"2015-08-16T17:39:15","date_gmt":"2015-08-16T09:39:15","guid":{"rendered":"http:\/\/ijz.me\/?p=731"},"modified":"2015-08-16T17:39:15","modified_gmt":"2015-08-16T09:39:15","slug":"%e5%b1%8f%e8%94%bdssh%e6%81%b6%e6%84%8f%e6%89%ab%e6%8f%8fip%e7%9a%84%e8%84%9a%e6%9c%ac","status":"publish","type":"post","link":"http:\/\/ijz.me\/?p=731","title":{"rendered":"\u5c4f\u853dssh\u6076\u610f\u626b\u63cfip\u7684\u811a\u672c"},"content":{"rendered":"<p>\u8fd1\u6765\u53d1\u73b0\u6709ip\u6076\u610f\u626b\u63cf\u670d\u52a1\u5668\uff0c\u5199\u4e2a\u811a\u672c\u81ea\u52a8\u5bf9\u6076\u610f\u653b\u51fb\u7684ip\u8fdb\u884c\u5c01\u7981\u3002\u4e3b\u8981\u539f\u7406\u662f\u5b9a\u671fcrontab\u4efb\u52a1\u5206\u6790secure\u65e5\u5fd7\uff08\u626b\u63cf\u5c1d\u8bd5\u767b\u9646\u7684\u4f1a\u6709\u9519\u8bef\u65e5\u5fd7\uff09\uff0c\u8d85\u8fc7\u9519\u8bef\u6b21\u6570\u5c31\u5c06\u5176\u52a0\u5165iptables DROP \u94fe\u63a5\u3002\u53ef\u4ee5\u5728\u4e00\u5b9a\u7a0b\u5ea6\u4e0a\u8bbf\u95ee\u6076\u610f\u653b\u51fb\u63d0\u4f9b\uff0c\u5b89\u5168\u6027\u3002\u9644\u4e0a\u811a\u672c\uff08\u4ee3\u7801\u53e6\u5b58\u4e3a<code>\/root\/block_ssh.sh<\/code>\u3002\u6267\u884c<code>echo \"*\/5 * * * * root \/root\/block_ssh.sh\" &gt;&gt;\/etc\/crontab<\/code> \u6bcf5\u5206\u949f\u68c0\u67e5\u4e00\u6b21\u6587\u4ef6\u3002\uff09<!--more--><\/p>\n<pre class=\"lang:sh decode:true \">#!\/bin\/bash\n#echo \"*\/5 * * * * root \/root\/block_ssh.sh\" &gt;&gt;\/etc\/crontab\nLIMIT=30\nLOGFILE=\"\/data\/block_ip.log\"\nTIME=$(date '+%b %e %H')\nBLOCK_IP=`perl -lane 'print $F[-4] if \/Failed password\/' \/var\/log\/secure|sort|uniq -c|perl -lane  'print \"$F[0]:$F[1]\"  if ($F[0] &gt; \"'$LIMIT'\")'`\n\nfor i in $BLOCK_IP\ndo\n\n  echo $i\n     IP=`echo $i|perl -F: -lane 'print $F[1]'`\n     echo $IP\n     iptables-save|grep INPUT|grep DROP|grep $IP&gt;\/dev\/null     #\u5148\u5224\u65ad\u4e0b\u662f\u5426\u5df2\u7ecf\u88ab\u5c4f\u853d\n     if [ $? -gt 0 ];then\n          iptables -I INPUT -s $IP -j DROP     #\u5c4f\u853dip\n          NOW=$(date '+%Y-%m-%d %H:%M')\n          echo -e \"$NOW : $IP\" &gt;&gt;${LOGFILE}\n     fi\ndone<\/pre>\n<p>&nbsp;<\/p>\n<p><code>\u00a0<\/code><\/p>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>\u8fd1\u6765\u53d1\u73b0\u6709ip\u6076\u610f\u626b\u63cf\u670d\u52a1\u5668\uff0c\u5199\u4e2a\u811a\u672c\u81ea\u52a8\u5bf9\u6076\u610f\u653b\u51fb\u7684ip\u8fdb\u884c\u5c01\u7981\u3002\u4e3b\u8981\u539f\u7406\u662f\u5b9a\u671fcrontab\u4efb\u52a1\u5206\u6790sec [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[21,6],"tags":[41,46,51],"class_list":["post-731","post","type-post","status-publish","format-standard","hentry","category-perl","category-6","tag-perl-one-liners","tag-shell","tag-51"],"_links":{"self":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/731","targetHints":{"allow":["GET"]}}],"collection":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcomments&post=731"}],"version-history":[{"count":0,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/731\/revisions"}],"wp:attachment":[{"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fmedia&parent=731"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcategories&post=731"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Ftags&post=731"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}