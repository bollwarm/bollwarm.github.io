{"id":827,"date":"2015-12-09T21:37:11","date_gmt":"2015-12-09T13:37:11","guid":{"rendered":"http:\/\/ijz.me\/?p=827"},"modified":"2015-12-09T21:37:11","modified_gmt":"2015-12-09T13:37:11","slug":"rex-advent-rex-%e6%89%b9%e9%87%8f%e9%83%a8%e7%bd%b2sshd%e5%af%86%e7%a0%81%e5%b0%9d%e8%af%95%e6%94%bb%e5%87%bb%e8%84%9a%e6%9c%ac","status":"publish","type":"post","link":"http:\/\/ijz.me\/?p=827","title":{"rendered":"rex advent\u2014\u2014  rex \u6279\u91cf\u90e8\u7f72sshd\u5bc6\u7801\u5c1d\u8bd5\u653b\u51fb\u811a\u672c"},"content":{"rendered":"<p>1\u3001\u9996\u5148\u662f\u9632\u653b\u51fb\u811a\u672c\uff0c\u539f\u7406\u662f\u626b\u63cf\/var\/log\/secure\u6587\u4ef6\uff0c\u53d1\u73b0\u4e00\u5c0f\u65f6\u5185\u5c1d\u8bd5\u5bc6\u7801\u9519\u8bef\u8d85\u8fc730\u6b21\u7684ip\uff0c\u5219<br \/>\n\u5c06\u8be5ip\u52a0\u5165iptables\u9ed1\u540d\u5355drop\u6389\u3002<\/p>\n<pre class=\"lang:default decode:true\">#!\/usr\/bin\/env perl\nmy $LIMIT=30;\nmy $log=\"\/var\/log\/secure\";\nmy $LOGFILE=\"\/data\/block_ip.log\";\nmy $TIME=`date '+%b %e %H'`;\nchomp $TIME;\nmy $BLOCK_IP;\nmy %hash;\nopen(FD,$log)||die(\"Can not open the file!$!n\");\n\nwhile(&lt;FD&gt;){\nchomp;\nif ( \/$TIME\/ and \/Failed password\/ )\n{\nmy @line=split;\nmy $ip=$line[-4];\n$hash{$ip}++;\n}\n}\nclose(FD);\n\nfor(%hash)\n{\n\nif ($hash{$_} &gt; $LIMIT)\n{\nmy $IP=$_;\n$ips= `iptables-save`;\n$mo= qr(\/INPUT\/ and \/DROP\/ and \/$IP\/);\nunless ($ips=~$mo)\n{\n`iptables -I INPUT -s $IP -j DROP`;\nmy $NOW=`date '+%Y-%m-%d %H:%M'`;\nchomp $NOW;\n`echo -e \"$NOW : $IP\" &gt;&gt;$LOGFILE`;\n}\n}\n}<\/pre>\n<p>2\u3001\u5c06\u8be5\u811a\u672c\u4fdd\u5b58\u4e3ablock_ssh.sh<br \/>\n3\u3001\u521b\u5efa\u4e00\u4e2a\u4e0a\u4f20\u4efb\u52a1\uff0c\u628a\u8be5\u6587\u4ef6\u4e0a\u4f20\u5230\u8fdc\u7a0b\u670d\u52a1\u5668\uff0c\u7ed9\u4e88\u6267\u884c\u6743\u9650\u3002\u52a0\u5165crontab \u6bcf5\u5206\u949f\u6267\u884c\u4e00\u6b21\u3002<\/p>\n<pre class=\"lang:default decode:true \"> task \"upload\",  group =&gt;\"all\", sub {\n say connection-&gt;server.\":begin upload files!\";\n   upload \"block_ssh.sh\", \"\/root\/block_ssh.sh\";\n    run \"chmod 755 \/root\/block_ssh.sh\";\n    run 'echo \"*\/5 * * * * root \/root\/block_ssh.sh\" &gt;&gt;\/etc\/crontab';\nsay connection-&gt;server.\":upload success!\";\n };<\/pre>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>1\u3001\u9996\u5148\u662f\u9632\u653b\u51fb\u811a\u672c\uff0c\u539f\u7406\u662f\u626b\u63cf\/var\/log\/secure\u6587\u4ef6\uff0c\u53d1\u73b0\u4e00\u5c0f\u65f6\u5185\u5c1d\u8bd5\u5bc6\u7801\u9519\u8bef\u8d85\u8fc730\u6b21\u7684ip\uff0c [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[21,23,6],"tags":[29,40,44,51],"class_list":["post-827","post","type-post","status-publish","format-standard","hentry","category-perl","category-rex","category-6","tag-advent","tag-perl","tag-rex","tag-51"],"_links":{"self":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/827","targetHints":{"allow":["GET"]}}],"collection":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcomments&post=827"}],"version-history":[{"count":0,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/827\/revisions"}],"wp:attachment":[{"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fmedia&parent=827"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcategories&post=827"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Ftags&post=827"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}