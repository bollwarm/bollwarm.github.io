{"id":704,"date":"2015-01-26T19:09:42","date_gmt":"2015-01-26T11:09:42","guid":{"rendered":"http:\/\/ijz.me\/?p=704"},"modified":"2015-01-26T19:09:42","modified_gmt":"2015-01-26T11:09:42","slug":"iptables%e5%92%8cipset%e6%89%b9%e9%87%8f%e9%99%90%e5%88%b6%e9%9d%9e%e6%b3%95ip%e6%ba%90","status":"publish","type":"post","link":"http:\/\/ijz.me\/?p=704","title":{"rendered":"iptables\u548cipset\u6279\u91cf\u9650\u5236\u975e\u6cd5ip\u6e90"},"content":{"rendered":"<p>\u4e00\u3001\u83b7\u53d6\u975e\u6cd5ip\u6e90\uff1a<\/p>\n<p>\u626b\u63cf\u767b\u5f55\u5931\u8d25\u7684\u65e5\u5fd7\uff1a<br \/>\nless secure*|grep &#8220;Failed password for root from&#8221;\u00a0 &gt;\/tmp\/gj.list<br \/>\n\u5bf9\u626b\u63cf\u65e5\u5fd7\u8fdb\u884c\u5206\u6790\uff0c\u975e\u6cd5\u5c1d\u8bd5\u5931\u8d25\u8d85\u8fc750\u7684ip\u5217\u51fa\u6765\uff0c\u4fdd\u5b58\u4e3agongji.ip<br \/>\ncat \/tmp\/gj.list|perl -anle\u00a0 &#8216;print $F[10]&#8217;|sort |uniq -c|sort -n |perl -anle &#8216;print $F[1] if $F[0]&gt;50 &#8216;&gt;\/tmp\/gongji.ip<\/p>\n<p><!--more--><\/p>\n<p>\u4e8c\u3001\u5b89\u88c5ipset\u8fdb\u884cip\u7ba1\u7406\uff08\u7565\uff09<\/p>\n<p>\u4e09\u3001\u5728ipset\u4e2d\u521b\u5efa\u4e00\u4e2aip\u7ec4\u7528\u4e8e\u5b58\u653e\u975e\u6cd5ip<\/p>\n<p>ipset -N banip iphash<\/p>\n<p>\u56db\u3001\u5199\u4e2a\u811a\u672c\u672c\u5c06ip\u52a0\u5165banip\u5206\u7ec4<\/p>\n<p>vim ipsetadd.sh<\/p>\n<p><code>_input<\/code>=\/tmp\/gongji.ip<\/p>\n<p><code>IPS=\/usr\/sbin\/ipset<\/code><\/p>\n<p><code>egrep -v \"^#|^$\" $_input | while IFS= read -r ip<\/code><\/p>\n<p><code>do<\/code><br \/>\n<code>\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0\u00a0 $IPS -A banip $ip<\/code><br \/>\n<code>done<\/code><\/p>\n<p>\u6267\u884csh ipsetadd.sh<\/p>\n<p>\u4e94\u3001iptables \u7981\u6b62\u8fd9\u4e9bip<\/p>\n<p>iptables -I INPUT -m set &#8211;match-set banip\u00a0 src -p tcp\u00a0\u00a0 -j DROP<\/p>\n<p>&nbsp;<\/p>\n<p>ok\uff0c\u6536\u5de5<\/p>\n<p>&nbsp;<\/p>\n","protected":false},"excerpt":{"rendered":"<p>\u4e00\u3001\u83b7\u53d6\u975e\u6cd5ip\u6e90\uff1a \u626b\u63cf\u767b\u5f55\u5931\u8d25\u7684\u65e5\u5fd7\uff1a less secure*|grep &#8220;Failed p [&hellip;]<\/p>\n","protected":false},"author":2,"featured_media":0,"comment_status":"open","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"footnotes":""},"categories":[18,21,24,6],"tags":[],"class_list":["post-704","post","type-post","status-publish","format-standard","hentry","category-iptables","category-perl","category-shell","category-6"],"_links":{"self":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/704","targetHints":{"allow":["GET"]}}],"collection":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts"}],"about":[{"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/users\/2"}],"replies":[{"embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcomments&post=704"}],"version-history":[{"count":0,"href":"http:\/\/ijz.me\/index.php?rest_route=\/wp\/v2\/posts\/704\/revisions"}],"wp:attachment":[{"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fmedia&parent=704"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Fcategories&post=704"},{"taxonomy":"post_tag","embeddable":true,"href":"http:\/\/ijz.me\/index.php?rest_route=%2Fwp%2Fv2%2Ftags&post=704"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}